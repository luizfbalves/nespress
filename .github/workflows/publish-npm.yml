# Workflow para publicar no npm usando Trusted Publishers (OIDC)
#
# CONFIGURA√á√ÉO NECESS√ÅRIA NO NPM:
# 1. Acesse: https://www.npmjs.com/settings/[seu-usuario]/features
# 2. Ative "Trusted Publishers"
# 3. Adicione o GitHub Publisher:
#    - Owner: seu-usuario-github ou organiza√ß√£o
#    - Repository: nome-do-repositorio
#    - Workflow filename: publish-npm.yml
#
# BENEF√çCIOS:
# - N√£o precisa de tokens (elimina risco de vazamento)
# - Autentica√ß√£o autom√°tica via OIDC
# - Atende √†s novas pol√≠ticas de seguran√ßa do npm (2025)
# - Provenance attestation autom√°tico
#
# Refer√™ncia: https://github.blog/changelog/2025-09-29-strengthening-npm-security-important-changes-to-authentication-and-token-management/

name: Publish to npm

on:
  release:
    types: [created]
  push:
    tags:
      - "v*"

jobs:
  test:
    name: Executar Testes üß™
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo üì•
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Configurar Bun üèÉ‚Äç‚ôÇÔ∏è
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Instalar depend√™ncias üì¶
        run: bun install --frozen-lockfile

      - name: Executar testes üß™
        run: bun test

      - name: Verificar cobertura de c√≥digo üìä
        run: bun test --coverage

  publish:
    name: Publicar no npm üì¶
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Para releases, usa o tag_name do evento
            TAG_NAME="${{ github.event.release.tag_name }}"
            VERSION=${TAG_NAME#v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Tag da release: $TAG_NAME"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Para push de tags direto
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(bun run --bun node -p "require('./package.json').version || '1.0.0'")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Vers√£o extra√≠da: ${{ steps.version.outputs.version }}"

      - name: Update package.json version
        run: |
          bun run --bun node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '${{ steps.version.outputs.version }}'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
          echo "package.json atualizado com vers√£o ${{ steps.version.outputs.version }}"

      - name: Build project
        run: |
          echo "üî® Construindo o projeto..."
          bun run build
          echo "‚úÖ Build conclu√≠do!"

          # Verificar se o diret√≥rio dist foi criado
          if [ ! -d "dist" ]; then
            echo "‚ùå Erro: diret√≥rio 'dist' n√£o foi criado ap√≥s o build"
            exit 1
          fi

          echo "üì¶ Arquivos no dist:"
          ls -la dist/ || echo "Diret√≥rio dist vazio ou n√£o encontrado"

      - name: Setup Node.js for npm publish (OIDC)
        uses: actions/setup-node@v4
        with:
          registry-url: "https://registry.npmjs.org"
          node-version: "20"
          # OIDC √© habilitado automaticamente quando:
          # 1. registry-url est√° configurado
          # 2. permissions.id-token: write est√° definido (j√° est√° no job)
          # 3. Trusted Publisher est√° configurado no npm
          # O setup-node@v4 automaticamente configura o .npmrc com OIDC

      - name: Validate package.json before publish
        run: |
          echo "=== Validando package.json ==="
          PACKAGE_NAME=$(bun run --bun node -p "require('./package.json').name")
          PACKAGE_VERSION=$(bun run --bun node -p "require('./package.json').version")

          if [ -z "$PACKAGE_NAME" ]; then
            echo "‚ùå Erro: campo 'name' n√£o encontrado no package.json"
            exit 1
          fi

          if [ -z "$PACKAGE_VERSION" ]; then
            echo "‚ùå Erro: campo 'version' n√£o encontrado no package.json"
            exit 1
          fi

          echo "‚úÖ Nome do pacote: $PACKAGE_NAME"
          echo "‚úÖ Vers√£o: $PACKAGE_VERSION"

          # Verificar se campos essenciais existem
          if ! bun run --bun node -e "const pkg = require('./package.json'); if (!pkg.description) throw new Error('description missing');" 2>/dev/null; then
            echo "‚ö†Ô∏è  Aviso: campo 'description' n√£o encontrado (recomendado)"
          fi

          echo ""
          echo "=== Conte√∫do do package.json ==="
          cat package.json

      - name: Check if package version already exists
        id: check_version
        run: |
          PACKAGE_NAME=$(bun run --bun node -p "require('./package.json').name")
          PACKAGE_VERSION=$(bun run --bun node -p "require('./package.json').version")

          echo "Verificando se vers√£o $PACKAGE_VERSION j√° existe no npm..."
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Vers√£o $PACKAGE_VERSION j√° existe no npm"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Vers√£o $PACKAGE_VERSION n√£o existe, pode publicar"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify OIDC authentication setup
        run: |
          echo "=== Verificando configura√ß√£o OIDC ==="
          echo "GitHub Actor: ${{ github.actor }}"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub Event: ${{ github.event_name }}"
          echo "GitHub Workflow: ${{ github.workflow }}"
          echo ""
          echo "Registry configurado:"
          npm config get registry
          echo ""
          echo "Verificando autentica√ß√£o npm..."
          npm whoami 2>&1 || echo "‚ö†Ô∏è  N√£o autenticado (normal para OIDC antes do publish)"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANTE - Verifique no npm:"
          echo "   1. Acesse: https://www.npmjs.com/settings/luizfbalves/features"
          echo "   2. Confirme que o Trusted Publisher est√° configurado:"
          echo "      - Owner: luizfbalves (EXATO, sem espa√ßos)"
          echo "      - Repository: nespress (EXATO, sem espa√ßos)"
          echo "      - Workflow filename: publish-npm.yml (EXATO, incluindo .yml)"
          echo "   3. Verifique se voc√™ √© o propriet√°rio do pacote 'nespress' no npm"
          echo "   4. Acesse: https://www.npmjs.com/package/nespress e verifique 'Maintainers'"
          echo ""
          echo "Testando acesso ao pacote (read-only)..."
          PACKAGE_NAME=$(bun run --bun node -p "require('./package.json').name")
          npm view "$PACKAGE_NAME" name 2>&1 | head -3 || echo "‚ö†Ô∏è  N√£o foi poss√≠vel ler informa√ß√µes do pacote"

      - name: Publish to npm using OIDC (Trusted Publishers)
        if: steps.check_version.outputs.exists != 'true'
        run: |
          echo "üì¶ Publicando no npm usando OIDC (Trusted Publishers)..."
          echo ""
          echo "Configura√ß√£o:"
          echo "  - Registry: https://registry.npmjs.org"
          echo "  - Package: $(bun run --bun node -p "require('./package.json').name")"
          echo "  - Version: $(bun run --bun node -p "require('./package.json').version")"
          echo "  - GitHub Actor: ${{ github.actor }}"
          echo "  - GitHub Repository: ${{ github.repository }}"
          echo ""

          # Verificar se o .npmrc foi criado pelo setup-node
          echo "Verificando configura√ß√£o npm..."
          if [ -f "$HOME/.npmrc" ]; then
            echo "‚úÖ Arquivo .npmrc encontrado"
            # Verificar se cont√©m configura√ß√£o OIDC (sem mostrar token)
            if grep -q "//registry.npmjs.org/:_authToken" "$HOME/.npmrc" 2>/dev/null; then
              echo "   ‚úÖ Cont√©m configura√ß√£o de autentica√ß√£o"
            else
              echo "   ‚ö†Ô∏è  N√£o encontrou configura√ß√£o de token (pode ser OIDC)"
            fi
          else
            echo "‚ùå Arquivo .npmrc n√£o encontrado!"
            echo "   O setup-node@v4 deveria criar automaticamente com OIDC"
            echo "   Isso pode indicar problema na configura√ß√£o do OIDC"
          fi

          echo ""
          echo "Verificando vari√°veis de ambiente OIDC..."
          env | grep -i "oidc\|token\|auth" | sed 's/=.*/=***/' || echo "Nenhuma vari√°vel OIDC encontrada (pode ser normal)"

          echo ""
          echo "Tentando publicar..."

          # Tentar publicar com informa√ß√µes de debug
          npm publish --access public --verbose 2>&1 || {
            EXIT_CODE=$?
            echo ""
            echo "‚ùå Erro ao publicar (c√≥digo: $EXIT_CODE)"
            echo ""
            echo "üîç Diagn√≥stico do erro 404:"
            echo "   Este erro geralmente indica problema de AUTENTICA√á√ÉO/PERMISS√ïES"
            echo ""
            echo "üìã Checklist de verifica√ß√£o:"
            echo ""
            echo "1. ‚úÖ Trusted Publisher configurado no npm?"
            echo "   ‚Üí https://www.npmjs.com/settings/luizfbalves/features"
            echo "   ‚Üí Verifique: Owner=luizfbalves, Repo=nespress, File=publish-npm.yml"
            echo ""
            echo "2. ‚úÖ Voc√™ √© propriet√°rio/maintainer do pacote 'nespress'?"
            echo "   ‚Üí https://www.npmjs.com/package/nespress"
            echo "   ‚Üí Verifique a aba 'Maintainers'"
            echo ""
            echo "3. ‚úÖ O workflow est√° sendo executado no reposit√≥rio correto?"
            echo "   ‚Üí Reposit√≥rio atual: ${{ github.repository }}"
            echo "   ‚Üí Deve ser: luizfbalves/nespress"
            echo ""
            echo "4. ‚úÖ O workflow filename est√° correto?"
            echo "   ‚Üí Nome atual: publish-npm.yml"
            echo "   ‚Üí Deve corresponder EXATAMENTE ao configurado no npm"
            echo ""
            echo "5. ‚úÖ Permiss√µes do workflow incluem id-token: write?"
            echo "   ‚Üí Verifique linha 60 do workflow"
            echo ""
            echo "üí° Dica: Se o pacote foi criado por outra conta, voc√™ precisa:"
            echo "   1. Ser adicionado como maintainer no npm"
            echo "   2. OU recriar o Trusted Publisher com a conta correta"
            echo ""
            exit $EXIT_CODE
          }
        continue-on-error: false
        # OIDC √© usado automaticamente quando id-token: write est√° nas permissions
        # N√£o √© necess√°rio NPM_TOKEN quando usando Trusted Publishers

      - name: Skip publish if version exists
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "‚ö†Ô∏è  Pulando publica√ß√£o: vers√£o j√° existe no npm"
          exit 0

      - name: Verify publication
        run: |
          echo "Package publicado com sucesso!"
          echo "Vers√£o: ${{ steps.version.outputs.version }}"
          echo "Nome do pacote: $(bun run --bun node -p "require('./package.json').name")"
